#include <gb/gb.h>

#define WHITE  0
#define SILVER 1
#define GRAY   2
#define BLACK  3

#define TONNETZ_EXPLORE  0
#define PLAY_PROGRESSION  1
#define SOUND_SELECT  2

#define PALETTE(c0, c1, c2, c3) c0 | c1 << 2 | c2 << 4 | c3 << 6

#define MAX(a,b) ((a) > (b) ? (a) : (b))
#define MIN(a,b) ((a) < (b) ? (a) : (b))

///////////////////////////////////////////////////////////////////
// All declarations for sound

void pofsound_player();
void play_ch1(UINT8 stop, UWORD f11bits,UINT8 duty,UINT8 vol);
void play_ch2(UINT8 stop, UWORD f11bits,UINT8 duty,UINT8 vol);
void play_ch3(UINT8 stop, UWORD f11bits,UINT8 *wavetable, UINT8 vol);
void play_ch4(UINT8 stop,UINT8 noisetype, UINT8 vol);
void regular_chords(UINT8 *chords,UINT8 chord_len);
void simple_arpeggio(UINT8 *chords,UINT8 chord_len);
void delayed_chords(UINT8 *chords,UINT8 chord_len);
void arpeggio_with_root(UINT8 *chords,UINT8 chord_len);


UINT16 ch1_clock=0; UINT16 ch1_index=0;
UINT16 ch2_clock=0; UINT16 ch2_index=0;
UINT16 ch3_clock=0; UINT16 ch3_index=0;
UINT8 flag_play1=0;
UINT8 flag_play2=0;
UINT8 flag_play3=0;

enum notes {
    C3, Cs3, D3, Eb3, E3, F3, Fs3, G3, Gs3, A3, Bb3, B3, // C3 to B3
    C4, Cs4, D4, Eb4, E4, F4, Fs4, G4, Gs4, A4, Bb4, B4, // C4 to B4
    C5, Cs5, D5, Eb5, E5, F5, Fs5, G5, Gs5, A5, Bb5, B5, // C5 to B5
    C6, Cs6, D6, Eb6, E6, F6, Fs6, G6, Gs6, A6, Bb6, B6, // C6 to B6
    C7, Cs7, D7, Eb7, E7, F7, Fs7, G7, Gs7, A7, Bb7, B7, // C7 to B7
    C8, Cs8, D8, Eb8, E8, F8, Fs8, G8, Gs8, A8, Bb8, B8,  // C8 to B8
    SILENCE
};

const UWORD frequencies[] = {
      44, 156, 262, 363, 457, 547, 631, 710, 786, 854, 923, 986, // C3 to B3
    1046,1102,1155,1205,1253,1297,1339,1379,1417,1452,1486,1517, // C4 to B4
    1546,1575,1602,1627,1650,1673,1694,1714,1732,1750,1767,1783, // C5 to B5
    1798,1812,1825,1837,1849,1860,1871,1881,1890,1899,1907,1915, // C6 to B6
    1923,1930,1936,1943,1949,1954,1959,1964,1969,1974,1978,1982, // C7 to B7
    1985,1988,1992,1995,1998,2001,2004,2006,2009,2011,2013,2015,  // C8 to B8
    0
};

const UINT8 ch3_wave_1[] = {0x7C,0xFF,0xEB,0xA9,0x86,0x53,0x21,0x11,0x13,0x55,0x41,0x00,0x24,0x54,0x21,0x37};
const UINT8 ch3_wave_2[] = {0x79,0xBC,0xDE,0xFF,0xFF,0xFE,0xDB,0xA8,0x75,0x42,0x10,0x00,0x00,0x12,0x34,0x67};
UINT16 ch1_notes[1100];
UINT16 ch1_len=0;
UINT16 ch2_notes[1100];
UINT16 ch2_len=0;
UINT16 ch3_notes[1100];
UINT16 ch3_len=0;

///////////////////////////////////////////////////////////////////
// Graphics (Should have put that in a separate file but hey...)

UINT8 splashscreen_tilemap[] = {197,197,197,197,197,127,126,197,197,197,197,197,197,197,197,197,197,
197,197,197,92,48,82,157,197,71,110,197,197,197,197,197,197,197,197,197,197,197,197,197,53,45,77,10,
197,75,128,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,74,106,197,197,197,
197,197,197,197,197,197,197,197,197,197,93,94,157,176,181,58,16,157,155,154,145,147,155,165,146,149,113,
80,153,150,22,134,10,137,12,40,175,10,136,76,11,37,136,68,13,42,173,35,79,44,197,197,197,197,197,197,197,
197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,197,43,81,118,
141,62,38,121,89,197,197,197,197,197,197,197,197,185,186,180,177,159,152,184,190,197,197,193,194,195,
196,197,197,197,189,124,51,83,54,132,46,166,19,122,18,59,148,182,197,197,197,197,197,144,23,57,131,25,
55,15,161,66,103,8,140,61,86,63,151,197,197,197,125,60,29,170,142,168,172,104,6,7,5,3,32,17,52,24,129,
178,197,197,90,28,133,101,26,197,197,197,197,197,197,197,49,14,98,91,95,107,197,197,85,64,115,183,197,
197,197,197,197,197,197,197,197,197,116,47,27,100,197,197,20,97,102,119,88,156,197,188,197,197,191,187,
179,56,65,138,167,96,197,197,114,164,36,34,87,139,99,143,120,73,117,67,39,108,112,123,31,197,197,197,
197,30,78,69,135,0,33,72,171,105,162,84,163,50,158,169,197,197,197,197,197,197,197,174,9,4,2,1,0,41,111,
109,21,160,130,197,197,197,197};

UINT8 main_tilemap[] = {91,80,80,80,80,80,80,80,80,80,81,80,80,80,80,82,37,37,37,37,89,37,30,37,30,37,30,
37,30,37,89,6,45,5,26,89,37,37,37,37,89,22,50,3,54,3,58,3,50,4,89,37,27,9,37,89,37,37,37,37,89,17,46,10,46,
10,46,10,46,14,89,37,31,2,37,89,37,37,37,37,89,19,75,7,67,7,71,7,75,13,89,37,37,23,37,89,37,37,37,37,89,37,
3,59,3,51,3,55,3,37,90,80,80,80,80,87,80,80,80,83,89,37,10,46,10,46,10,46,10,37,89,34,35,37,37,37,37,37,37,
89,89,37,7,72,7,64,7,68,7,37,89,33,36,37,37,37,37,37,37,89,89,22,52,3,56,3,48,3,52,4,89,37,37,37,37,37,37,
37,37,89,89,17,46,10,46,10,46,10,46,14,89,37,37,37,37,37,37,37,37,89,89,19,65,7,69,7,73,7,65,13,89,37,37,
37,37,37,37,37,37,89,89,37,3,49,3,53,3,57,3,37,89,37,37,37,37,37,37,37,37,89,89,37,10,46,10,46,10,46,10,
37,89,37,37,37,37,37,37,37,37,89,89,37,7,74,7,66,7,70,7,37,89,37,37,37,37,37,37,37,37,89,89,22,54,3,58,3,
50,3,54,4,89,37,37,37,37,37,37,37,37,89,89,18,46,10,46,10,46,10,46,14,90,80,80,80,80,80,80,80,80,86,89,20,
67,11,71,11,75,11,67,15,89,32,97,96,98,99,37,37,37,89,85,80,80,80,80,80,80,80,80,80,88,80,80,80,80,80,80,80,80,84};

const UINT8 SPLASHSCREEN_TILESET[] = {255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,63,63,255,255,255,255,255,255,255,255,255,255,255,255,127,127,0,0,255,
255,255,255,255,255,255,255,255,255,63,127,1,3,0,0,255,255,255,255,255,255,255,255,255,255,15,15,0,0,0,0,255,255,
255,255,255,255,255,255,255,255,0,0,0,0,0,0,255,255,255,255,255,255,255,255,0,128,0,0,0,0,0,0,255,255,255,255,255,
255,255,255,0,2,0,0,0,0,0,0,255,255,255,255,254,255,190,190,255,255,255,255,255,255,255,255,255,255,255,255,127,127,
15,15,1,0,0,0,0,0,0,0,255,255,224,240,126,126,63,63,21,31,0,0,0,0,0,0,254,254,204,206,254,254,252,254,86,126,0,0,0,
0,0,0,254,254,148,222,192,192,0,128,0,0,0,0,0,0,0,0,253,253,153,157,253,253,249,253,172,252,0,0,0,0,0,0,249,249,127,
127,15,15,1,1,0,0,0,0,0,0,0,0,254,240,191,70,93,1,79,0,251,0,191,96,255,99,255,105,24,24,28,28,4,12,0,0,152,152,28,
156,156,156,24,28,16,16,136,136,40,168,132,132,196,196,176,176,224,225,244,245,0,16,152,152,112,112,0,0,4,4,130,130,
43,171,169,169,24,8,24,0,0,0,0,0,51,51,121,121,189,189,255,255,16,8,24,0,8,16,16,0,0,16,0,0,0,0,0,0,22,6,157,28,119,
112,127,255,255,252,240,224,0,0,0,0,14,14,12,14,14,14,12,14,6,6,0,0,0,0,0,0,12,12,8,8,0,8,28,28,2,6,128,128,4,4,4,4,
6,15,28,24,0,0,0,0,176,176,62,62,1,1,1,1,12,4,4,4,6,0,6,0,2,2,2,0,0,0,224,224,11,3,24,0,240,0,128,128,0,0,0,0,0,0,0,
0,9,1,232,232,0,0,0,0,0,0,128,0,192,192,96,32,7,6,11,143,16,16,48,16,96,96,64,64,67,64,7,6,6,6,134,6,98,194,32,0,0,0,
2,2,57,59,64,65,6,6,1,1,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0,4,0,0,0,0,52,48,44,32,72,64,144,128,244,244,255,255,253,253,255,
255,255,255,247,247,255,255,31,31,244,244,255,255,247,245,255,255,255,255,255,255,255,255,255,255,244,244,1,1,5,5,4,4,
130,2,3,3,85,85,5,5,243,243,123,251,59,59,31,31,7,15,3,3,3,3,1,1,240,240,0,0,0,0,0,0,0,1,1,1,37,37,161,161,231,231,
198,231,231,231,198,231,99,99,0,0,0,0,0,0,224,224,144,144,146,146,229,229,133,133,130,130,0,0,0,0,224,224,128,128,
0,0,0,0,0,0,0,0,0,0,224,224,222,254,230,230,227,227,193,225,96,96,0,0,0,0,0,0,223,251,253,253,255,255,255,255,255,
255,255,255,255,255,255,255,206,206,140,206,206,206,140,206,198,198,0,0,0,0,0,0,200,200,169,169,170,170,235,235,
170,170,169,169,0,0,0,0,199,199,142,207,255,255,252,254,212,252,128,192,192,192,128,192,195,195,131,195,195,195,
131,195,193,193,0,0,0,0,0,0,192,192,128,128,6,0,142,6,22,6,87,6,255,6,191,7,192,192,96,96,97,105,120,120,224,224,
3,1,32,32,96,96,3,3,251,251,255,255,215,255,195,195,131,195,195,195,131,195,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,14,
63,34,35,35,35,59,50,0,0,8,0,238,128,0,2,0,1,81,83,0,0,0,0,3,3,6,6,134,6,1,1,1,1,0,128,0,128,1,1,1,1,58,58,224,224,
1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,0,0,208,192,57,56,1,1,5,1,1,0,1,1,0,0,4,6,12,12,24,24,51,48,39,32,15,0,0,1,
0,0,0,0,128,128,11,10,11,2,0,0,192,0,1,0,0,0,0,0,62,62,0,0,0,0,32,64,96,32,0,0,252,252,254,254,235,255,227,227,199,
231,255,255,254,255,0,0,248,248,2,2,0,0,1,1,7,2,14,4,160,168,0,0,207,206,129,128,0,0,192,192,96,96,48,48,7,7,0,0,201,
201,199,199,208,208,144,144,160,160,64,64,16,16,0,0,192,192,64,64,128,128,0,0,192,192,0,0,0,0,0,0,128,196,32,96,198,
198,3,3,128,128,128,128,129,128,192,192,96,96,14,78,7,7,0,0,0,0,128,128,128,128,160,192,120,48,0,0,0,0,132,135,228,
229,6,6,1,1,255,175,255,255,255,255,255,255,255,255,255,255,255,255,255,255,192,128,193,1,1,1,0,0,32,32,112,48,120,
24,252,64,187,187,187,187,187,187,49,185,152,152,0,0,0,0,0,0,181,181,175,175,127,127,255,255,255,255,255,255,255,
255,127,127,176,176,40,40,40,40,168,168,176,176,0,0,0,0,0,0,175,184,175,184,175,168,175,186,175,185,175,184,191,
159,191,128,164,164,87,87,235,171,254,250,255,255,255,255,255,255,255,255,128,160,128,192,3,3,64,0,96,64,64,96,96,
64,193,96,191,128,223,128,127,127,0,0,0,0,0,0,0,0,0,0,191,128,191,128,183,136,171,148,183,136,191,128,191,128,180,
139,157,157,25,157,157,157,28,156,132,140,0,0,0,0,0,0,156,156,24,156,156,156,24,156,140,140,0,0,0,0,0,0,149,149,
235,235,221,221,63,63,31,31,7,7,1,1,0,0,143,143,29,159,255,255,249,253,169,249,1,129,129,129,0,128,0,0,128,128,
192,192,192,192,227,227,67,227,99,99,243,243,0,0,128,128,169,169,18,18,42,42,169,169,0,0,0,0,0,0,128,128,128,
128,0,128,240,240,248,248,188,252,24,156,0,0,112,224,176,176,147,129,16,0,8,0,28,8,12,8,0,0,184,0,152,0,120,24,
188,24,190,24,188,24,190,24,0,0,121,121,57,57,1,1,0,0,0,0,8,0,8,8,0,0,115,115,242,246,3,3,0,0,17,17,48,0,0,32,
0,0,64,64,84,84,42,43,169,169,29,31,183,183,111,111,0,0,64,0,128,0,0,0,0,0,30,30,254,254,0,0,0,0,51,51,68,68,
102,102,68,68,68,68,0,0,0,0,0,0,33,35,46,36,8,8,16,16,0,0,0,0,0,0,0,0,2,50,100,4,200,8,144,16,7,15,0,0,0,64,0,
0,31,31,31,31,11,15,1,1,1,1,1,1,1,1,0,0,14,14,15,15,15,15,15,15,13,15,14,14,14,14,0,0,12,12,14,14,12,14,142,142,
204,206,238,238,108,110,0,0,8,8,4,4,6,6,2,2,224,224,0,1,0,3,132,136,136,128,136,128,0,0,0,0,0,0,0,0,192,192,129,
129,130,131,134,130,76,68,64,64,0,0,0,0,16,24,128,128,128,128,130,130,128,128,98,104,49,50,0,8,0,4,128,128,96,96,
48,48,8,8,1,1,131,131,46,47,101,101,80,208,192,192,0,0,0,0,152,128,152,128,128,136,136,128,50,178,2,2,1,1,128,132,
128,128,0,192,0,128,0,32,1,129,1,1,9,9,0,0,1,1,0,0,0,0,56,56,255,127,254,254,255,255,255,253,255,255,255,255,255,
255,255,255,231,119,255,127,255,255,255,255,254,254,0,0,0,0,0,0,252,96,238,96,249,0,254,128,253,65,253,241,255,242,
255,250,218,102,236,156,240,240,0,0,0,0,0,0,0,0,0,0,232,72,16,32,8,16,0,0,0,0,0,0,0,0,28,12,224,64,160,96,112,32,
48,16,56,16,24,16,0,0,0,0,254,24,255,24,127,64,247,119,255,255,255,255,248,252,0,0,245,29,245,157,245,93,245,157,
245,29,253,25,253,241,253,1,255,0,255,236,215,149,255,251,255,247,255,255,255,255,252,254,0,0,4,4,12,12,8,8,16,16,
32,32,96,96,64,64,0,0,3,3,3,3,7,7,7,7,7,7,15,15,15,15,0,0,3,3,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,192,192,6,7,2,2,
64,64,193,193,0,0,1,1,0,0,0,0,1,1,4,4,16,16,0,0,0,0,0,0,192,192,56,56,0,0,0,0,103,0,34,0,0,0,0,0,144,144,153,153,
149,149,212,212,0,0,0,0,0,0,0,0,131,1,128,130,0,0,112,112,89,89,240,240,0,0,0,0,120,120,192,224,0,0,0,0,0,0,0,0,
0,0,0,0,98,98,85,85,85,85,98,98,64,64,0,0,0,0,0,0,60,60,240,240,128,128,84,85,85,85,189,191,0,0,0,0,32,0,16,32,
32,16,48,16,48,16,48,16,0,0,0,0,1,1,2,2,0,0,24,24,6,6,3,1,0,0,0,0,0,1,3,3,4,4,0,0,0,0,16,16,0,0,0,0,0,0,254,254,
5,253,255,255,253,1,253,249,0,0,0,0,0,0,127,127,160,183,255,255,191,128,191,159,253,1,229,25,229,25,61,193,61,193,
255,7,255,9,246,58,196,6,7,3,4,5,12,12,16,16,0,0,224,224,227,225,176,16,128,0,0,0,0,0,0,0,0,0,0,0,0,0,140,12,4,4,
0,0,16,16,16,16,8,8,1,9,0,0,128,0,1,129,135,7,76,12,0,0,239,32,176,32,240,160,128,0,0,0,8,16,92,64,52,48,24,24,200,
8,192,48,126,126,60,62,30,30,28,30,6,14,0,0,0,0,0,0,119,119,127,127,255,255,255,255,255,255,255,255,255,255,255,
255,115,115,99,115,115,115,99,115,49,49,0,0,0,0,0,0,97,113,115,115,63,63,31,31,5,15,0,0,0,0,0,0,96,96,96,96,0,0,
128,128,192,192,160,224,167,167,0,0,96,64,192,64,128,192,128,128,160,160,42,170,245,245,255,255,74,74,224,224,128,
128,240,240,225,225,253,253,252,252,250,250,64,64,64,64,205,205,81,81,81,81,208,208,0,0,0,0,64,64,64,64,76,64,204,
196,140,128,136,132,12,0,13,9,96,32,96,64,0,0,3,3,18,178,176,176,176,176,240,240,0,0,0,0,0,0,0,7,0,0,1,1,12,12,16,
16,0,0,0,0,0,0,0,0,248,248,252,252,30,30,252,254,0,0,0,0,0,0,0,0,241,241,249,249,61,61,249,253,0,0,0,0,0,0,0,0,220,
220,254,254,239,255,198,231,0,0,0,0,0,0,0,0,128,192,2,2,1,1,0,0,0,0,0,0,0,0,0,0,184,184,252,252,222,254,140,206,0,
0,0,0,0,0,0,0,184,184,252,252,222,254,135,199,0,0,0,0,0,0,0,0,128,128,96,96,0,0,132,64,0,0,0,0,0,0,0,0,128,128,4,
4,4,12,12,8,0,0,0,0,0,0,0,0,113,113,249,249,189,253,15,143,0,0,0,0,0,0,0,0,112,112,248,248,188,252,24,156,0,0,0,
0,0,0,0,0,110,110,127,127,119,127,99,115,0,0,0,0,0,0,0,0,64,64,48,60,4,14,1,1,0,0,0,0,0,0,0,0,60,60,126,126,198,
198,255,255,0,0,0,0,0,0,0,0,60,52,94,6,137,0,124,0,0,0,0,0,0,0,0,0,31,31,0,0,0,0,0,0,127,8,127,9,252,156,240,224,
0,0,0,0,0,0,0,0,95,6,255,7,127,13,255,229,255,111,255,47,255,255,255,127,76,4,204,14,184,56,243,240,214,192,91,0,
183,0,253,64,62,58,7,3,0,0,0,0,0,0,32,0,16,0,163,3,49,57,176,176,32,48,16,16,0,0,18,18,27,27,9,9,48,48,56,56,8,24,
0,0,49,49,57,57,184,184,49,185,48,48,8,8,6,6,3,3,128,0,177,1,254,2,255,90,16,48,24,16,25,1,0,0,0,0,2,2,228,228,68,
4,53,21,7,4,6,4,7,6,13,0,63,32,95,207,248,240,49,17,50,2,2,0,16,0,112,64,192,64,0,128,0,0,48,16,24,16,24,8,12,0,0,
4,1,1,0,0,32,160,50,0,10,0,223,160,255,234,255,117,239,237,255,255,255,255,46,0,167,128,235,129,183,53,223,95,248,
254,128,0,0,0,31,31,29,31,60,60,56,60,8,24,0,0,0,0,0,0,31,31,3,3,0,0,0,0,0,0,0,0,0,0,0,0,28,28,24,28,28,28,152,156,
76,204,0,0,0,0,0,0,0,0,0,0,0,0,0,0,30,30,63,63,119,127,121,121,0,0,0,0,0,0,0,0,0,0,138,138,14,14,6,6,0,0,0,0,0,0,0,
0,0,0,0,32,16,16,128,0,0,0,0,0,0,0,0,0,0,0,15,15,0,0,48,48,0,0,0,0,0,0,0,0,0,0,9,9,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
128,128,252,252,0,0,0,0,0,0,0,0,0,0,0,0,128,0,128,128,0,0,0,0,0,0,0,0,0,0,0,0,0,16,4,4,0,0,0,0,0,0,0,0,0,0,0,0,14,
14,1,1,0,0,0,0,0,0,0,0,0,0,0,0,3,3,12,12,0,0,0,0,0,0,0,0,0,0,0,0,2,2,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,128,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,1,1,25,25,21,21,25,25,20,20,25,25,0,0,0,0,0,0,0,0,0,0,0,0,119,119,21,21,117,117,69,69,119,119,0,0,0,0,0,0,119,
119,20,20,119,119,65,65,119,119,0,0,0,0,0,0,25,25,21,21,25,25,20,20,25,25,0,0,0,0,0,0,176,176,40,40,40,40,168,168,
176,176,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

const UINT8 TILESET[] = {224,224,144,144,151,151,231,231,146,146,145,145,0,0,0,0,128,136,0,8,0,4,0,4,0,4,0,2,0,2,0,
254,128,128,128,128,160,160,160,160,192,192,192,192,128,128,0,0,0,129,0,129,0,129,0,66,0,66,0,66,0,36,0,36,0,128,0,
128,0,128,0,64,0,64,0,64,0,32,0,32,0,128,0,128,0,64,0,64,1,33,0,32,3,19,12,28,112,112,72,72,72,72,112,112,75,75,75,
75,1,1,0,0,0,36,0,36,0,66,0,66,0,66,0,129,0,129,0,129,0,64,0,32,3,35,1,33,6,22,25,25,96,112,0,8,48,56,128,136,192,
196,128,132,0,2,128,130,128,129,128,255,0,36,0,24,0,24,0,255,0,24,0,24,0,24,0,36,0,36,0,0,0,66,0,0,0,66,0,0,0,129,
0,0,3,35,1,33,0,64,1,65,1,65,1,129,1,129,1,255,0,32,0,32,0,64,0,64,0,64,0,128,0,128,0,128,0,32,0,16,0,16,0,240,0,
16,0,16,0,16,0,32,0,32,0,0,0,64,0,0,0,64,0,0,0,128,0,0,0,4,0,8,128,136,0,8,192,208,48,48,12,28,1,33,0,4,0,8,0,8,0,
15,0,8,0,8,0,8,0,4,0,4,0,8,0,8,0,15,0,8,0,8,0,8,0,0,0,4,0,4,0,2,0,2,0,2,0,1,0,1,0,1,0,4,0,0,0,2,0,0,0,2,0,0,0,1,0,
0,1,1,1,1,5,5,5,5,3,3,3,3,1,1,0,0,0,1,0,1,0,1,0,2,0,2,0,2,0,4,0,4,0,0,224,224,144,144,144,144,224,224,128,128,128,
128,0,0,0,0,7,7,4,4,4,4,7,7,4,4,4,4,0,0,0,0,0,0,128,128,128,128,0,0,0,0,0,0,0,0,8,8,8,8,8,8,8,8,232,232,239,239,64,
64,128,128,6,14,0,8,1,17,0,16,0,32,0,32,0,64,0,127,16,16,16,16,208,208,208,208,144,144,30,30,0,0,0,0,0,0,0,0,64,64,
64,64,128,128,128,128,0,0,0,0,0,0,0,0,0,36,0,0,0,66,0,0,0,129,0,0,0,0,0,0,2,2,2,2,1,1,1,1,0,0,0,0,13,12,30,20,252,
228,191,196,156,228,238,244,21,28,12,12,0,4,255,12,28,28,251,28,12,12,28,28,24,24,0,0,0,0,0,0,0,4,251,4,0,4,255,12,
28,28,251,28,0,4,0,4,0,4,255,12,28,28,251,28,0,4,255,12,28,28,251,28,12,12,255,28,24,24,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,192,194,128,130,96,100,152,156,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,
0,128,0,128,0,64,0,64,0,0,12,12,16,16,16,16,16,16,16,16,12,12,0,0,0,0,48,48,64,64,64,64,70,70,68,68,50,50,6,6,0,0,
24,24,20,20,20,20,20,20,20,20,24,24,0,0,0,0,112,112,64,64,100,100,68,68,70,70,117,117,6,6,0,0,56,56,32,32,48,48,32,
32,32,32,56,56,0,0,0,0,28,28,16,16,16,16,24,24,16,16,16,16,0,0,0,0,56,56,32,32,32,32,54,54,36,36,34,34,6,6,0,0,24,
24,32,32,32,32,44,44,36,36,24,24,0,0,0,0,48,48,64,64,64,64,91,91,74,74,49,49,3,3,0,0,24,24,20,20,20,20,28,28,20,20,
20,20,0,0,0,0,96,96,80,80,100,100,84,84,86,86,101,101,6,6,0,0,48,48,40,40,48,48,40,40,40,40,48,48,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,24,24,32,32,32,32,24,24,0,0,0,0,0,0,48,48,64,64,70,70,52,52,2,2,6,6,0,0,0,0,8,8,8,8,24,24,40,40,40,40,24,24,
0,0,0,0,48,48,84,84,100,100,70,70,53,53,6,6,0,0,0,0,12,12,20,20,24,24,16,16,12,12,0,0,0,0,0,0,24,24,32,32,48,48,32,
32,32,32,0,0,0,0,0,0,24,24,32,32,54,54,36,36,34,34,6,6,0,0,0,0,12,12,20,20,12,12,4,4,24,24,0,0,0,0,0,0,48,48,80,80,
54,54,20,20,98,98,6,6,0,0,0,0,0,0,24,24,40,40,40,40,28,28,0,0,0,0,0,0,64,64,64,64,116,116,84,84,102,102,5,5,6,6,0,
0,32,32,32,32,56,56,40,40,48,48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,0,0,255,0,255,255,0,0,0,0,0,0,0,0,255,255,
0,0,255,0,211,231,44,36,36,44,0,0,0,0,192,192,48,48,200,8,184,200,92,100,36,44,0,0,0,0,192,192,48,48,136,24,184,
200,92,100,36,44,44,36,100,76,216,136,40,24,176,112,192,192,0,0,0,0,44,36,54,34,25,17,22,24,12,15,3,3,0,0,0,0,44,
36,36,44,236,196,4,12,204,4,228,204,44,36,36,44,44,36,36,44,235,199,0,0,255,0,255,255,0,0,0,0,44,36,36,44,203,199,
0,0,255,0,255,255,0,0,0,0,44,36,36,44,44,36,36,44,44,36,36,44,44,36,36,44,44,36,36,44,39,35,32,32,35,32,35,39,44,
36,36,44,0,0,0,0,3,3,12,12,19,16,23,17,42,38,36,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,3,3,8,8,24,24,64,64,192,192,0,0,0,0,0,
0,126,126,0,0,126,126,0,0,126,126,0,0,0,0,0,0,6,6,0,0,30,30,0,0,126,126,0,0,0,0,2,2,20,20,40,40,64,64,0,0,126,
126,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

const unsigned char ball_sprite[] = {0, 0, 24, 24, 60, 36, 122, 70, 114, 78, 36, 60, 24, 24, 0, 0};
const unsigned char triangle_sprite[] = {96, 96, 80, 80, 104, 72, 116, 76, 104, 88, 80, 112, 96, 96, 0, 0};
const unsigned char sound_mode_sprite[] = {255,255,129,129,129,129,129,129,129,129,129,129,129,129,255,255};

///////////////////////////////////////////////////////////////////
// This stores the coordinates of the chords in the Tonnetz
// Simple LUT for moving the selector ball around...

const UINT8 LUT_positions[] = {
	 6,8,0,0,0,0, // 0,0 -  CM
	 3,11,0,0,0,0,// 1,0 -  C#M
	 2,2,8,2,6,14,// 2,0 -  DM
	 5,5,0,0,0,0,// 3,0 -  EbM
	 2,8,8,8,0,0, // 4,0 -  EM
	 5,11,0,0,0,0,// 5,0 -  FM
	 4,2,2,14,8,14,// 6,0 -  F#M
	 7,5,0,0,0,0,// 7,0 -  GM
	 4,8,0,0,0,0, // 8,0 -  G#M
	 7,11,0,0,0,0,// 9,0 -  AM
	 6,2,4,14,0,0,// 10,0 -  BbM
	 3,5,0,0,0,0,// 11,0 -  BM

	 5,7,0,0,0,0, // 0,1 -  Cm
	 2,10,8,10,0,0,// 1,1 -  C#m
	 5,13,0,0,0,0,// 2,1 -  Dm
	 4,4,2,16,8,16,// 3,1 -  Ebm
	 7,7,0,0,0,0, // 4,1 -  Em
	 4,10,0,0,0,0,// 5,1 -  Fm
	 7,13,0,0,0,0,// 6,1 -  F#m
	 6,4,4,16,0,0,// 7,1 -  Gm
	 3,7,0,0,0,0, // 8,1 -  G#m
	 6,10,0,0,0,0,// 9,1 -  Am
	 3,13,0,0,0,0,// 10,1 -  Bbm
	 2,4,8,4,6,16,// 11,1 -  Bm
};

///////////////////////////////////////////////////////////////////
//// SOUND FUNCTIONS
///////////////////////////////////////////////////////////////////


// Play a note without any effects on CH1
void play_ch1(UINT8 stop, UWORD f11bits,UINT8 duty,UINT8 vol) {
    if (stop) {
      NR12_REG = 0x00;
    } else {
      NR10_REG = 0x00;
      NR11_REG = duty<<6;
      NR12_REG = (vol<<4) | 0xF;
      NR13_REG = (UINT8)(f11bits&255);
      NR14_REG = 0x80 | (f11bits>>8); // NRx4 always last
    }
}

// Play a note without any effects on CH2
void play_ch2(UINT8 stop, UWORD f11bits,UINT8 duty,UINT8 vol) {
  if (stop) {
      NR22_REG = 0x00;
    } else {
      NR21_REG = duty<<6;
      NR22_REG = (vol<<4) | 0xF;
      NR23_REG = (UINT8)(f11bits&255);
      NR24_REG = 0x80 | (f11bits>>8);
    }
}

// Given a wavetable, play a note without any effect on CH3
void play_ch3(UINT8 stop, UWORD f11bits,UINT8 *wavetable, UINT8 vol) {
  unsigned char *dst = (unsigned char *)(0xFF30u); // Create pointer to the wave RAM.
  UINT8 i;

  if (stop) {
      NR34_REG = 0x00;
      NR30_REG = 0x00;
  } else {
    /// ALWAYS, ALWAYS, ALWAYS SWITCH OFF NR30_REG, WRITE WAVETABLE, SWITCH ON NR30_REG
    /// AND ONLY THEN !!! SWITCH ON NR34_REG
    
    NR30_REG = 0x00;
    for (i=0;i<16;i++)
      dst[i]= wavetable[i];
    NR30_REG = 0x80;

    NR33_REG = (UINT8)(f11bits&255);
    NR32_REG = vol<<5;
    NR31_REG = 0x00;
    NR34_REG = 0x80 | (f11bits>>8);
  }
}

// This is not used in this software
void play_ch4(UINT8 stop,UINT8 noisetype, UINT8 vol) {
  if (stop) {
    NR42_REG = 0x00;
    NR44_REG = 0x00;
  } else {
    NR41_REG = 0x00;
    NR42_REG = (vol<<4) | 0xF;
    NR43_REG = noisetype;
    NR44_REG = 0x80;
  }
}

// This is the callback on the TIM interrupt for playing music
// If the flags are on, it regularly ticks the chX_clock variables
// If the clock exceeds the current duration, we advance to the next note in the chX_notes array
void pofsound_player()
{
  UINT16 freq;
  UINT8 duty;

  
  if (flag_play1 && ch1_len) {
    // TIM interrupt is clocked at 16384/256 = 64Hz
	  ch1_clock++;
	  if (ch1_clock>ch1_notes[ch1_index+1]) {
	    ch1_clock=0;
	    freq = frequencies[ch1_notes[ch1_index]];
	    duty = ch1_notes[ch1_index+2]&3;
	    if (freq==0)
	      play_ch1(1,0,0,15);
	    else
	      play_ch1(0,freq,duty,15);
	    ch1_index+=3;
	    if (ch1_index==ch1_len) {
          play_ch1(1,0,0,15);
	      ch1_index=0;
	      flag_play1=0;
	    }
	  }
    }

    if (flag_play2 && ch2_len) {
      ch2_clock++;
      if (ch2_clock>ch2_notes[ch2_index+1]) {
        ch2_clock=0;
        freq = frequencies[ch2_notes[ch2_index]];
        duty = ch2_notes[ch2_index+2]&3;
        if (freq==0)
          play_ch2(1,0,0,15);
        else
          play_ch2(0,freq,duty,15);
        ch2_index+=3;
        if (ch2_index==ch2_len) {
          play_ch2(1,0,0,15);
          ch2_index=0;
          flag_play2=0;
        }
      }
	}

    if (flag_play3 && ch3_len) {
      ch3_clock++;
      if (ch3_clock>ch3_notes[ch3_index+1]) {
        ch3_clock=0;
        freq = frequencies[ch3_notes[ch3_index]];
        if (freq==0)
          play_ch3(1,0,0,1);
        else
          play_ch3(0,freq,ch3_wave_1,1);
        ch3_index+=3;
        if (ch3_index==ch3_len) {
          play_ch3(1,0,0,1);
          ch3_index=0;
          flag_play3=0;
        }
      }
    }
}

////////////////////////////////////////////////////////////////////
// A series of functions for filling the note arrays
// 1/ Regular plain chords
// 2/ Arpeggiated single notes
// 3/ Chords with delayed entries of the voices
// 4/ Root bass with arpeggiated notes

void regular_chords(UINT8 *chords,UINT8 chord_len) {
    UINT8 i;

    ch1_len=6*chord_len;
    ch2_len=6*chord_len;
    ch3_len=6*chord_len;
    for (i=0;i<chord_len;i++) {
        ch3_notes[6*i] = (UINT16)(chords[2*i]+24);
        ch3_notes[6*i+1] = 0x0000;
        ch3_notes[6*i+2] = 0x0001;
        ch3_notes[6*i+3] = SILENCE;
        ch3_notes[6*i+4] = 0x00A0;
        ch3_notes[6*i+5] = 0x0002;

        ch2_notes[6*i] = (UINT16)(chords[2*i]+12+4-chords[2*i+1]);
        ch2_notes[6*i+1] = 0x0000;
        ch2_notes[6*i+2] = 0x0002;
        ch2_notes[6*i+3] = SILENCE;
        ch2_notes[6*i+4] = 0x00A0;
        ch2_notes[6*i+5] = 0x0002;

        ch1_notes[6*i] = (UINT16)(chords[2*i]+12+7);
        ch1_notes[6*i+1] = 0x0000;
        ch1_notes[6*i+2] = 0x0001;
        ch1_notes[6*i+3] = SILENCE;
        ch1_notes[6*i+4] = 0x00A0;
        ch1_notes[6*i+5] = 0x0002;
    }
}

void delayed_chords(UINT8 *chords,UINT8 chord_len) {
    UINT8 i;

    ch1_len=6*chord_len;
    ch2_len=6*chord_len;
    ch3_len=6*chord_len;
    for (i=0;i<chord_len;i++) {
        ch3_notes[6*i] = (UINT16)(chords[2*i]+24);
        ch3_notes[6*i+1] = 0x0000;
        ch3_notes[6*i+2] = 0x0001;
        ch3_notes[6*i+3] = SILENCE;
        ch3_notes[6*i+4] = 0x00A0;
        ch3_notes[6*i+5] = 0x0002;

        ch2_notes[6*i] = (UINT16)(chords[2*i]+12+4-chords[2*i+1]);
        ch2_notes[6*i+1] = 0x0035;
        ch2_notes[6*i+2] = 0x0002;
        ch2_notes[6*i+3] = SILENCE;
        ch2_notes[6*i+4] = 0x006B;
        ch2_notes[6*i+5] = 0x0002;

        ch1_notes[6*i] = (UINT16)(chords[2*i]+12+7);
        ch1_notes[6*i+1] = 0x0067;
        ch1_notes[6*i+2] = 0x0001;
        ch1_notes[6*i+3] = SILENCE;
        ch1_notes[6*i+4] = 0x0039;
        ch1_notes[6*i+5] = 0x0002;
    }
}

void simple_arpeggio(UINT8 *chords,UINT8 chord_len) {
    UINT8 i;

    ch1_len=18*chord_len;
    ch2_len=0;
    ch3_len=0;
    for (i=0;i<chord_len;i++) {
        ch1_notes[18*i] = (UINT16)(chords[2*i]+12);
        ch1_notes[18*i+1] = 0x0010;
        ch1_notes[18*i+2] = 0x0002;
        ch1_notes[18*i+3] = SILENCE;
        ch1_notes[18*i+4] = 0x0010;
        ch1_notes[18*i+5] = 0x0002;
        ch1_notes[18*i+6] = (UINT16)(chords[2*i]+12+4-chords[2*i+1]);
        ch1_notes[18*i+7] = 0x0010;
        ch1_notes[18*i+8] = 0x0002;
        ch1_notes[18*i+9] = SILENCE;
        ch1_notes[18*i+10] = 0x0010;
        ch1_notes[18*i+11] = 0x0002;
        ch1_notes[18*i+12] = (UINT16)(chords[2*i]+12+7);
        ch1_notes[18*i+13] = 0x0010;
        ch1_notes[18*i+14] = 0x0002;
        ch1_notes[18*i+15] = SILENCE;
        ch1_notes[18*i+16] = 0x0010;
        ch1_notes[18*i+17] = 0x0002;
    }
}

void arpeggio_with_root(UINT8 *chords,UINT8 chord_len) {
    UINT8 i;

    ch1_len=21*chord_len;
    ch2_len=0;
    ch3_len=6*chord_len;
    for (i=0;i<chord_len;i++) {
        ch1_notes[21*i] = (UINT16)(chords[2*i]+12-7);
        ch1_notes[21*i+1] = 0x0000;
        ch1_notes[21*i+2] = 0x0002;
        ch1_notes[21*i+3] = (UINT16)(chords[2*i]+12);
        ch1_notes[21*i+4] = 0x0020;
        ch1_notes[21*i+5] = 0x0002;
        ch1_notes[21*i+6] = (UINT16)(chords[2*i]+12+4-chords[2*i+1]);
        ch1_notes[21*i+7] = 0x0020;
        ch1_notes[21*i+8] = 0x0002;
        ch1_notes[21*i+9] = (UINT16)(chords[2*i]+12);
        ch1_notes[21*i+10] = 0x0020;
        ch1_notes[21*i+11] = 0x0002;
        ch1_notes[21*i+12] = (UINT16)(chords[2*i]+12+4-chords[2*i+1]);
        ch1_notes[21*i+13] = 0x0020;
        ch1_notes[21*i+14] = 0x0002;
        ch1_notes[21*i+15] = (UINT16)(chords[2*i]+12+7);
        ch1_notes[21*i+16] = 0x0020;
        ch1_notes[21*i+17] = 0x0002;
        ch1_notes[21*i+18] = SILENCE;
        ch1_notes[21*i+19] = 0x0020;
        ch1_notes[21*i+20] = 0x0002;

        ch3_notes[6*i] = (UINT16)(chords[2*i]+24);
        ch3_notes[6*i+1] = 0x0000;
        ch3_notes[6*i+2] = 0x0001;
        ch3_notes[6*i+3] = SILENCE;
        ch3_notes[6*i+4] = 0x00C5;
        ch3_notes[6*i+5] = 0x0002;
    }
}

///////////////////////////////////////////////////////////////////
//// MAIN LOOP
//// It is big and a bit ugly, I guess this is the acceptable limit
//// for this small piece of software.
///////////////////////////////////////////////////////////////////

void main(void) {
    
	UINT8 keys;
	UINT8 counter=0;
	UINT8 current_chord[2];
	UINT8 i,j,k,KEY_COUNTER,SELECT_MODE,SOUND_MODE;
	UINT8 ball_x[]={0,0,0};
	UINT8 ball_y[]={0,0,0};
	
	UINT8 chord_progression[144];
	UINT8 chord_progression_len=0;


    // An array of function pointers for selecting how we fill the notes
    void (*fill_notes[4])(UINT8*,UINT8) = {regular_chords,simple_arpeggio,delayed_chords,arpeggio_with_root};
	

	// INTIALIZATIONS

	KEY_COUNTER=0; // A small delay between key presses for optimal UX
    SOUND_MODE=0; // SOUND_MODE selects how we fill the notes
    current_chord[0]=0;current_chord[1]=0; // We start on C major. First element controls the root, second the chord type.
	// Nothing in the chord progression at first
    for (i=0;i<144;i++) {
		chord_progression[i]=0;
        ch1_notes[i]=0;
        ch2_notes[i]=0;
        ch3_notes[i]=0;
	}

    // The selector starts initially on the Tonnetz
	SELECT_MODE = TONNETZ_EXPLORE;
	
	// Copy the tileset in the video memory
	set_sprite_data(0, 8, ball_sprite);
	set_sprite_data(8,8,triangle_sprite);
    set_sprite_data(16,8,sound_mode_sprite);
	set_sprite_tile(0,0);
	set_sprite_tile(1,0);
	set_sprite_tile(2,0);
	set_sprite_tile(3,1);
    set_sprite_tile(4,2);
	
	for (i=0;i<3;i++) {
		ball_x[i] = 8*LUT_positions[6*(current_chord[0]+current_chord[1]*12)+2*i];
		ball_y[i] = 8*LUT_positions[6*(current_chord[0]+current_chord[1]*12)+2*i+1];
		if (ball_x[i]>0)
			ball_x[i]+=8;
		if (ball_y[i]>0)
			ball_y[i]+=16;	
		move_sprite(i,ball_x[i],ball_y[i]);
	}
	move_sprite(3,0,0);
    move_sprite(4,104+8*SOUND_MODE,144); // Hardcoded... bad....

	BGP_REG = PALETTE(WHITE, SILVER, GRAY, BLACK);
	OBP0_REG = PALETTE(GRAY,WHITE, SILVER, BLACK);
	
	// Setup SOUND
	

	NR52_REG = 0x80; // General Audio ON/OFF
	NR51_REG = 0xFF; // L&R for each channel
	NR50_REG = 0x77; // Volumes
	
  
    /////////////////////////////////////
	// Setup the PofSound player
    // (yes, I named it like that....)

	disable_interrupts();
	add_TIM(pofsound_player);
	enable_interrupts();
	TMA_REG = 0;
    // Set clock to 16384 Hertz 
    // 00: 4096 Hz // 01: 262144 Hz // 10: 65536 Hz // 11: 16384 Hz
    // Last bit is to activate the timer
    TAC_REG = 6;
    // Handle VBL and TIM interrupts
    set_interrupts(TIM_IFLAG | VBL_IFLAG);
    
    
    // Display the background layer

    set_bkg_data(0, 256, SPLASHSCREEN_TILESET);
	set_bkg_tiles(0, 0, 20, 18, splashscreen_tilemap);

    SHOW_BKG;
	waitpad(J_START);

	set_bkg_data(0, 256, TILESET);
	set_bkg_tiles(0, 0, 20, 18, main_tilemap);
	SHOW_SPRITES;
	
   while (1) {
        keys = joypad();
        KEY_COUNTER++;
		
		// Down and up keys are only used in the Tonnetz
		if ((keys & J_DOWN) && (current_chord[1]==0) && (KEY_COUNTER>10)) {
			current_chord[1]=1;
			current_chord[0]=(current_chord[0]+9)%12;

			KEY_COUNTER=0;
		}

		if ((keys & J_UP) && (current_chord[1]==1) && (KEY_COUNTER>10)) {
			current_chord[1]=0;
			current_chord[0]=(current_chord[0]+3)%12;

			KEY_COUNTER=0;
		}

        // We need to make a difference whether we are in Tonnetz mode, or sound select mode
        if ((keys & J_RIGHT) && (KEY_COUNTER>10)) {
            switch (SELECT_MODE) {
                case TONNETZ_EXPLORE:
                    if (current_chord[1]==0) {
                        current_chord[0]=(current_chord[0]+4)%12;
                    }
                    current_chord[1]=1-current_chord[1];
                    break;
                case SOUND_SELECT:
                    if (SOUND_MODE<3)
                        SOUND_MODE++;
                    break;
                default:
                    break;
            }
    		KEY_COUNTER=0;
    	}

        // Same here...    
        if ((keys & J_LEFT) && (KEY_COUNTER>10)) {
            switch (SELECT_MODE) {
                case TONNETZ_EXPLORE:
        			if (current_chord[1]==1) {
        				current_chord[0]=(current_chord[0]+8)%12;
        			}
        			current_chord[1]=1-current_chord[1];
                    break;
                case SOUND_SELECT: 
                    if (SOUND_MODE>0)
                        SOUND_MODE--;
                    break;
                default:
                    break;
            }

    		KEY_COUNTER=0;
    	}
    	
        // If any arrow key has been pressed, we update the location of the selector ball(s)
        if (keys) {
    		for (i=0;i<3;i++) {
    			ball_x[i] = 8*LUT_positions[6*(current_chord[0]+current_chord[1]*12)+2*i];
    			ball_y[i] = 8*LUT_positions[6*(current_chord[0]+current_chord[1]*12)+2*i+1];
    			if (ball_x[i]>0)
    				ball_x[i]+=8;
    			if (ball_y[i]>0)
    				ball_y[i]+=16;	

    			if (SELECT_MODE==TONNETZ_EXPLORE)
    				move_sprite(i,ball_x[i],ball_y[i]);
    		}
    	}

        //// A and B are used to add/remove chords in the progression. It only works in Tonnetz mode

		/// Do we remove the chord from the progression ? 
		if ((keys & J_A) && (KEY_COUNTER>5) && SELECT_MODE==TONNETZ_EXPLORE) {
			chord_progression[2*chord_progression_len]=0;
			chord_progression[2*chord_progression_len+1]=0;
			if (chord_progression_len>0)
				chord_progression_len--;
			
			for (i=0,j=0,k=0;i<48;i++,k++) {
				if (k==8) (k=0,j++); // Do some modulo to find the y and x positions of the tile to display
				if (i<chord_progression_len) {
					main_tilemap[(8+j)*20+11+k]=48+16*chord_progression[2*i+1]+chord_progression[2*i];
				} else {
					main_tilemap[(8+j)*20+11+k]=37;
				}
			}
			set_bkg_tiles(0, 0, 20, 18, main_tilemap);

			KEY_COUNTER=0;
		}
		/// Do we select the chord for the progression ?
		if ((keys & J_B) && (KEY_COUNTER>5) && SELECT_MODE==TONNETZ_EXPLORE) {
			if (chord_progression_len<48) {
				chord_progression[2*chord_progression_len]=current_chord[0];
				chord_progression[2*chord_progression_len+1]=current_chord[1];
				chord_progression_len++;
			}
			
			for (i=0,j=0,k=0;i<48;i++,k++) {
				if (k==8) (k=0,j++); // Do some modulo to find the y and x positions of the tile to display
				if (i<chord_progression_len) {
					main_tilemap[(8+j)*20+11+k]=48+16*chord_progression[2*i+1]+chord_progression[2*i];
				} else {
					main_tilemap[(8+j)*20+11+k]=37;
				}
			}
			set_bkg_tiles(0, 0, 20, 18, main_tilemap);

			KEY_COUNTER=0;
		}

		// START is used to play chords
		if ((keys & J_START) && (KEY_COUNTER>10)) {
			switch (SELECT_MODE) {
				case TONNETZ_EXPLORE:
                    fill_notes[SOUND_MODE](current_chord,1);
					flag_play1=1;
                    flag_play2=1;
                    flag_play3=1;
					break;

				case PLAY_PROGRESSION:
                    fill_notes[SOUND_MODE](chord_progression,chord_progression_len);
					flag_play1=1;
                    flag_play2=1;
                    flag_play3=1;
					break;
				default:
					break;
			}

			KEY_COUNTER=0;
		}

        // SELECT switches between the different modes
        // We need to show/hide the corresponding sprites in each case
		if ((keys & J_SELECT) && (KEY_COUNTER>10)) {
			SELECT_MODE++;
			if (SELECT_MODE==3) {
				SELECT_MODE=TONNETZ_EXPLORE;
				counter=39;
			}
			switch (SELECT_MODE) {
				case TONNETZ_EXPLORE:
                    move_sprite(4,104+8*SOUND_MODE,144);
					move_sprite(3,0,0);
                    move_sprite(4,104+8*SOUND_MODE,144);
					break;
				case PLAY_PROGRESSION:
					for (i=0;i<3;i++)
						move_sprite(i,0,0);
					break;
				case SOUND_SELECT:
                    move_sprite(4,104+8*SOUND_MODE,144);
					break;
				default:
                    break;
			}
			KEY_COUNTER=0;
		}
		
        // Counter code for blinking things
		
		counter++;
		if (counter==40) {
			counter=0;
			switch (SELECT_MODE) {
				case TONNETZ_EXPLORE:
					for (i=0;i<3;i++)
						move_sprite(i,ball_x[i],ball_y[i]);
					break;
				case PLAY_PROGRESSION:
						move_sprite(3,93,68);
						break;
				case SOUND_SELECT:
						move_sprite(4,104+8*SOUND_MODE,144);
						break;
				default:
					
					break;
			}
		}
		if (counter==20) {
			switch (SELECT_MODE) {
				case TONNETZ_EXPLORE:
					for (i=0;i<3;i++)
						move_sprite(i,0,0);
					break;
				case PLAY_PROGRESSION:
						move_sprite(3,0,0);
						break;
				case SOUND_SELECT:
						move_sprite(4,0,0);
						break;
				default:
					break;
			}
		}
		
        // Wait until the screen was redrawn
		wait_vbl_done();
    }
}
